# v1.2.0 - Plan RPVEA 2.0

**Feature**: Corrección de bugs en filtros de fecha y ordenamiento
**Fecha**: 2025-11-30
**Metodología**: RPVEA 2.0

---

## R - Requisitos

### Análisis de la Documentación API (APIconsolidada.md)

#### Parámetro `from` / `to`

Según la documentación oficial (líneas 130-136):

| Nombre | Descripción | Formato | Defecto |
|--------|-------------|---------|---------|
| `from` | Fecha de inicio de la **última actualización** de la norma | AAAAMMDD | Fecha más antigua |
| `to` | Fecha de fin de la **última actualización** de la norma | AAAAMMDD | Fecha actual |

**HALLAZGO CRÍTICO**: `from`/`to` filtran por **fecha de actualización**, NO por `fecha_disposicion` ni `fecha_publicacion`.

Esto explica el comportamiento:
- Cuando pedimos `from=20240101`, filtra normas **actualizadas** desde 2024
- Pero la `fecha_disposicion` puede ser de cualquier año (ej: 2018)
- La API devuelve normas ordenadas por `fecha_actualizacion` descendente

#### Parámetro `query` con `range`

Para filtrar por `fecha_disposicion` o `fecha_publicacion`, hay que usar el objeto `range` DENTRO de la query (líneas 205-219):

```json
{
  "query": {
    "range": {
      "fecha_publicacion": {"gte": "20240101", "lte": "20241231"}
    },
    "query_string": {"query": "..."}
  }
}
```

#### Parámetro `sort`

Según documentación (líneas 222-241):

```json
{
  "sort": [{"fecha_publicacion": "desc"}, {"departamento": "asc"}]
}
```

**HALLAZGO**: El `sort` es parte del objeto JSON de `query`, no un parámetro separado.

### Diagnóstico del Bug Actual

| Problema | Causa Raíz | Solución |
|----------|------------|----------|
| `from_date`/`to_date` no filtra como esperado | Filtra por `fecha_actualizacion`, no por `fecha_disposicion` | Documentar comportamiento real; añadir `fecha_disposicion_desde/hasta` usando `range` |
| `sort_by` falla | Posible problema de serialización o la API no lo soporta en combinación con query_string | Investigar en V1 |

### Gaps a Resolver en v1.2.0

| ID | Gap | Prioridad | Solución Propuesta |
|----|-----|-----------|-------------------|
| BUG-01 | `from_date`/`to_date` confunde usuarios | Alta | Renombrar a `actualizado_desde`/`actualizado_hasta` y documentar |
| BUG-02 | No hay filtro por `fecha_disposicion` | Alta | Añadir `fecha_disposicion_desde`/`fecha_disposicion_hasta` usando `range` |
| BUG-03 | No hay filtro por `fecha_publicacion` | Alta | Añadir `fecha_publicacion_desde`/`fecha_publicacion_hasta` usando `range` |
| BUG-04 | `sort_by` no funciona | Media | Investigar y corregir serialización |

---

## P - Plan de Validación

### Criterios de Aceptación - REVISADOS tras V1.2

#### CA-01: Documentación clara de `from`/`to`
- [ ] Docstring explica que filtra por fecha de **actualización** del sistema, no disposición
- [ ] Incluye advertencia y ejemplo de comportamiento

#### CA-02: Filtro por fecha_disposicion ✅ VIABLE (requiere ambos límites)
- [x] `range` funciona SI se proporcionan `gte` Y `lte` - **CONFIRMADO en V1.2**
- [ ] Implementar `fecha_disposicion_desde` + `fecha_disposicion_hasta` (ambos obligatorios)

#### CA-03: Filtro por fecha_publicacion ✅ VIABLE (requiere ambos límites)
- [x] `range` funciona SI se proporcionan `gte` Y `lte` - **CONFIRMADO en V1.2**
- [ ] Implementar `fecha_publicacion_desde` + `fecha_publicacion_hasta` (ambos obligatorios)

#### CA-04: Ordenamiento funciona ✅ VALIDADO en V1
- [x] `sort` funciona con `query_string` - **CONFIRMADO**
- [ ] Implementar parámetros `ordenar_por` y `ordenar_direccion`
- [ ] Query genera `"sort": [{"campo": "direccion"}]`
- [ ] Resultados ordenados correctamente

### Casos de Prueba - REVISADOS tras V1.2

| ID | Parámetro | Entrada | Query Esperada | Resultado Esperado |
|----|-----------|---------|----------------|-------------------|
| TC01 | ordenar_por | "fecha_disposicion" | `"sort": [{"fecha_disposicion": "desc"}]` | Resultados ordenados por fecha desc |
| TC02 | ordenar_por + ordenar_direccion | "fecha_disposicion" + "asc" | `"sort": [{"fecha_disposicion": "asc"}]` | Resultados ordenados por fecha asc |
| TC03 | rango + ordenar | rango_codigo="1300" + ordenar_por="fecha_disposicion" | Query con filtro y sort | Leyes ordenadas por fecha desc |
| TC04 | Verificar from_date | from_date="20250101" | Sin cambio en query | Documenta que filtra por actualización |
| TC05 | fecha_publicacion ambos | desde="20250101" + hasta="20251130" | `"range": {"fecha_publicacion": {"gte":"20250101", "lte":"20251130"}}` | Solo normas publicadas en 2025 |
| TC06 | fecha_disposicion ambos | desde="20250101" + hasta="20251130" | `"range": {"fecha_disposicion": {"gte":"20250101", "lte":"20251130"}}` | Solo normas dispuestas en 2025 |
| TC07 | Combinación completa | rango + fecha_pub + ordenar | Query con todos los filtros | Leyes de 2025 ordenadas |
| TC08 | **Autocompletado: solo desde** | fecha_pub_desde="20200101" | `"range": {"fecha_publicacion": {"gte":"20200101", "lte":"20251130"}}` | Autocompleta hasta=hoy |
| TC09 | **Autocompletado: solo hasta** | fecha_pub_hasta="20201231" | `"range": {"fecha_publicacion": {"gte":"19780101", "lte":"20201231"}}` | Autocompleta desde=1978 |

---

## V - Validación Pre-Implementación

### V1 - Validación API Directa ✅ COMPLETADA (2025-11-30)

#### Test V1.1: Verificar comportamiento actual de `from` ✅ CONFIRMADO

```bash
curl -s "https://www.boe.es/datosabiertos/api/legislacion-consolidada?from=20240101&limit=3" \
  -H "Accept: application/json" | jq '.data[] | {fecha_actualizacion, fecha_disposicion}'
```

**Resultado**:
```json
{"fecha_actualizacion": "20251130T095834Z", "fecha_disposicion": "20181205"}
{"fecha_actualizacion": "20251130T095832Z", "fecha_disposicion": "20181010"}
{"fecha_actualizacion": "20251130T095832Z", "fecha_disposicion": "20181102"}
```

**Conclusión**: `from`/`to` filtra por `fecha_actualizacion`, NO por `fecha_disposicion`. Las normas devueltas fueron actualizadas hoy (2025-11-30) pero son de 2018.

#### Test V1.2: Probar `range` en query ❌ NO FUNCIONA

```bash
# URL encoded: {"query":{"range":{"fecha_disposicion":{"gte":"20240101"}}}}
curl -s "https://www.boe.es/datosabiertos/api/legislacion-consolidada?limit=3&query=..." \
  -H "Accept: application/json"
```

**Resultado**: La API IGNORA silenciosamente el filtro `range`. Devuelve las mismas normas de 2018.

#### Test V1.3: Probar `range` + `query_string` ❌ NO FUNCIONA

```bash
# Con rango@codigo:"1300" + range
curl -s "..." -H "Accept: application/json"
```

**Resultado**: El `range` es ignorado. Solo se aplica el filtro de `rango@codigo`.

#### Test V1.4: Probar `sort` ✅ **FUNCIONA**

```bash
# URL encoded: {"query":{"query_string":{"query":"rango@codigo:\"1300\""}},"sort":[{"fecha_disposicion":"desc"}]}
curl -s "https://www.boe.es/datosabiertos/api/legislacion-consolidada?limit=5&query=..." \
  -H "Accept: application/json"
```

**Resultado**:
```json
{"fecha_disposicion": "20251015", "titulo": "Ley 4/2025, de 15 de octubre..."}
{"fecha_disposicion": "20251009", "titulo": "Ley 5/2025, de 9 de octubre..."}
{"fecha_disposicion": "20251009", "titulo": "Ley 4/2025, de 9 de octubre..."}
{"fecha_disposicion": "20250909", "titulo": "Ley 7/2025, de 9 de septiembre..."}
{"fecha_disposicion": "20250730", "titulo": "Ley 8/2025, de 30 de julio..."}
```

**Conclusión**: El `sort` FUNCIONA correctamente. Hay leyes de 2025 en la base de datos.

### Hallazgos Críticos V1

| Test | Resultado | Implicación |
|------|-----------|-------------|
| V1.1 from/to | ✅ Confirmado | Documenta que filtra por actualización, no disposición |
| V1.2 range solo | ❌ No funciona | API ignora range |
| V1.3 range+query | ❌ No funciona | API ignora range incluso con query_string |
| V1.4 sort | ✅ **Funciona** | Podemos ordenar por fecha_disposicion desc |

**HALLAZGO PRINCIPAL**: El parámetro `range` documentado en la API **NO FUNCIONA** o es ignorado silenciosamente. Sin embargo, `sort` SÍ funciona y permite obtener las normas más recientes ordenándolas.

### Nueva Estrategia para v1.2.0

Dado que `range` no funciona:

1. **NO implementar** `fecha_disposicion_desde/hasta` (no hay forma técnica)
2. **SÍ implementar** `sort_by` correctamente para ordenar resultados
3. **Documentar** claramente el comportamiento de `from_date`/`to_date`
4. **Workaround**: Usar `sort` por `fecha_disposicion desc` + `limit` alto para obtener normas recientes

### V2 - Validación con MCP Local

Pendiente - Adaptar tests a la nueva estrategia (solo sort, no range).

### V3 - Validación End-to-End

Pendiente después de V2.

---

## E - Ejecución (Pendiente)

### Cambios Propuestos en `server.py` - REVISADO tras V1.2

#### Nuevos Parámetros

```python
# Filtros por fecha (requieren AMBOS límites para funcionar)
fecha_publicacion_desde: str | None = None,  # AAAAMMDD
fecha_publicacion_hasta: str | None = None,  # AAAAMMDD
fecha_disposicion_desde: str | None = None,  # AAAAMMDD
fecha_disposicion_hasta: str | None = None,  # AAAAMMDD

# Parámetros de ordenamiento
ordenar_por: Literal["fecha_disposicion", "fecha_publicacion", "titulo"] | None = None,
ordenar_direccion: Literal["asc", "desc"] = "desc",
```

#### Modificación de Construcción de Query

```python
from datetime import datetime

# Constantes para fechas por defecto
FECHA_MINIMA_DEFAULT = "19780101"  # Constitución Española
FECHA_HOY = datetime.now().strftime("%Y%m%d")  # Fecha actual dinámica

# Autocompletar rangos de fecha (la API requiere AMBOS límites)
# Si el usuario solo especifica uno, completamos el otro automáticamente
if fecha_publicacion_desde or fecha_publicacion_hasta:
    if "range" not in query_obj_def["query"]:
        query_obj_def["query"]["range"] = {}
    query_obj_def["query"]["range"]["fecha_publicacion"] = {
        "gte": fecha_publicacion_desde or FECHA_MINIMA_DEFAULT,
        "lte": fecha_publicacion_hasta or FECHA_HOY
    }

if fecha_disposicion_desde or fecha_disposicion_hasta:
    if "range" not in query_obj_def["query"]:
        query_obj_def["query"]["range"] = {}
    query_obj_def["query"]["range"]["fecha_disposicion"] = {
        "gte": fecha_disposicion_desde or FECHA_MINIMA_DEFAULT,
        "lte": fecha_disposicion_hasta or FECHA_HOY
    }

# Añadir sort si se especifica
if ordenar_por:
    query_obj_def["sort"] = [{ordenar_por: ordenar_direccion}]
```

**Lógica de autocompletado:**

| Usuario especifica | Sistema completa con |
|-------------------|---------------------|
| Solo `desde` ("desde 2010") | `hasta` = fecha de hoy (dinámico) |
| Solo `hasta` ("hasta 2020") | `desde` = 19780101 (Constitución) |
| Ambos | Usa los valores del usuario |
| Ninguno | No aplica filtro de fecha |

#### Actualización de Docstring

```python
"""
Args:
    from_date: Fecha mínima de ACTUALIZACIÓN del sistema (AAAAMMDD).
              ⚠️ IMPORTANTE: Filtra por cuándo se actualizó la norma en el BOE,
              NO por fecha de disposición/publicación de la norma.

    fecha_publicacion_desde: Fecha mínima de publicación (AAAAMMDD).
              Si solo se especifica este, 'hasta' se autocompleta con fecha de hoy.
    fecha_publicacion_hasta: Fecha máxima de publicación (AAAAMMDD).
              Si solo se especifica este, 'desde' se autocompleta con 19780101.

    fecha_disposicion_desde: Fecha mínima de disposición (AAAAMMDD).
              Si solo se especifica este, 'hasta' se autocompleta con fecha de hoy.
    fecha_disposicion_hasta: Fecha máxima de disposición (AAAAMMDD).
              Si solo se especifica este, 'desde' se autocompleta con 19780101.

    ordenar_por: Campo por el que ordenar resultados.
                 Valores: "fecha_disposicion", "fecha_publicacion", "titulo"

    ordenar_direccion: Dirección del ordenamiento ("asc" o "desc", por defecto "desc").
"""
```

### Consideraciones de Seguridad

- [x] `ordenar_por` validado con Literal
- [x] `ordenar_direccion` validado con Literal
- [ ] Validar formato de fechas (AAAAMMDD, 8 dígitos)
- [ ] Validar que desde <= hasta

### Ejemplos de Uso Esperado

```python
# Ejemplo 1: Leyes publicadas en 2025, ordenadas por fecha
search_laws_list(
    rango_codigo="1300",
    fecha_publicacion_desde="20250101",
    fecha_publicacion_hasta="20251130",
    ordenar_por="fecha_disposicion",
    ordenar_direccion="desc",
    limit=10
)

# Ejemplo 2: "Busca leyes desde 2010" (autocompletado hasta=hoy)
search_laws_list(
    rango_codigo="1300",
    fecha_publicacion_desde="20100101",
    # fecha_publicacion_hasta se autocompleta con fecha de hoy
    ordenar_por="fecha_disposicion",
    ordenar_direccion="desc"
)

# Ejemplo 3: "Busca la última ley de protección de datos"
search_laws_list(
    query_value="protección datos",
    rango_codigo="1300",
    ordenar_por="fecha_disposicion",
    ordenar_direccion="desc",
    limit=1
)
```

---

## A - Aceptación (Pendiente)

### Checklist Final

- [ ] V1 pasa (API directa)
- [ ] V2 pasa (tests locales)
- [ ] V3 pasa (end-to-end)
- [ ] Docstring actualizado
- [ ] Tests de regresión no rompen funcionalidad existente
- [ ] PR creado con descripción completa

### Registro de Validación para PR

```markdown
## Validación RPVEA 2.0

### Requisitos
- [x] Documentación API analizada
- [x] Comportamiento de from/to clarificado
- [x] Criterios de aceptación definidos

### Validación
- [ ] V1: API directa - Tests TC01-TC04
- [ ] V2: MCP Local - X/X tests pasan
- [ ] V3: MCP End-to-End - Parámetros en schema

### Criterios de Aceptación
- [ ] CA-01: Documentación from/to clara
- [ ] CA-02: fecha_disposicion funciona
- [ ] CA-03: fecha_publicacion funciona
- [ ] CA-04: sort investigado/documentado
```

---

## Estado Actual (2025-11-30)

### V1.2 - Investigación Adicional ✅ COMPLETADA

#### HALLAZGO CRÍTICO: `range` SÍ FUNCIONA con condiciones

Después de investigar la documentación de [Elasticsearch Range Query](https://www.elastic.co/docs/reference/query-languages/query-dsl/query-dsl-range-query) y probar múltiples variantes:

| Configuración | Resultado | Ejemplo |
|---------------|-----------|---------|
| `range` con solo `gte` | ❌ NO FUNCIONA | `{"gte": "20240101"}` → API ignora |
| `range` con `gte` Y `lte` | ✅ **FUNCIONA** | `{"gte": "20240101", "lte": "20241231"}` |
| `range` + `query_string` (ambos límites) | ✅ **FUNCIONA** | Combina filtro de fecha + otros filtros |

#### Prueba Exitosa

```bash
# Query: Leyes (1300) publicadas en 2024
curl "...query={
  'query': {
    'range': {'fecha_publicacion': {'gte': '20240101', 'lte': '20241231'}},
    'query_string': {'query': 'rango@codigo:\"1300\"'}
  }
}"
```

**Resultado:**
```json
{"fecha_publicacion": "20240729", "rango": "1300", "titulo": "Ley 3/2024..."}
{"fecha_publicacion": "20241031", "rango": "1300", "titulo": "Ley 3/2024..."}
{"fecha_publicacion": "20241221", "rango": "1300", "titulo": "Ley 7/2024..."}
```

#### Conclusión

La API del BOE **requiere ambos límites** (`gte` Y `lte`) para que `range` funcione. Esto es una limitación de la implementación del BOE, no de Elasticsearch.

### Nueva Estrategia para v1.2.0 (Revisada)

1. **SÍ implementar** filtros de fecha usando `range` con autocompletado inteligente
2. **SÍ implementar** `ordenar_por` y `ordenar_direccion`
3. **Autocompletar** automáticamente el límite faltante:
   - Solo `desde` → `hasta` = fecha de hoy
   - Solo `hasta` → `desde` = 19780101 (Constitución)
4. **Documentar** comportamiento de `from_date`/`to_date`

---

## CHECKPOINT (2025-11-30 ~20:30)

### Estado: Investigación V1 completada, listo para implementación

**Completado:**
- ✅ R - Requisitos analizados
- ✅ P - Plan definido con criterios de aceptación
- ✅ V1 - Validación API directa
- ✅ V1.2 - Investigación Elasticsearch (descubierto que `range` requiere ambos límites)
- ✅ Documentación actualizada con autocompletado inteligente

**Pendiente:**
- ⏳ E - Ejecución: Implementar cambios en `server.py`
- ⏳ V2/V3 - Validación MCP
- ⏳ A - Aceptación: Tests + PR

**Próximo paso:** Implementar los cambios en `server.py` según el plan documentado.

---

## V1.3 - Tests Adicionales de Confirmación (2025-11-30 ~20:45)

### Test V1.3.1: `range` con `fecha_disposicion` ✅ PASADO

```bash
curl "...query={'query':{'range':{'fecha_disposicion':{'gte':'20250101','lte':'20251130'}}}}"
```

**Resultado:**
```json
{"fecha_disposicion": "20251119", "rango": "Real Decreto", "titulo": "Real Decreto 1040/2025..."}
{"fecha_disposicion": "20251112", "rango": "Real Decreto", "titulo": "Real Decreto 1027/2025..."}
{"fecha_disposicion": "20250422", "rango": "Real Decreto", "titulo": "Real Decreto 345/2025..."}
```

✅ Todas las fechas son de 2025. `range` funciona con `fecha_disposicion`.

### Test V1.3.2: Combinación completa `range` + `sort` + `query_string` ✅ PASADO

```bash
curl "...query={
  'query': {
    'range': {'fecha_publicacion': {'gte': '20250101', 'lte': '20251130'}},
    'query_string': {'query': 'rango@codigo:\"1300\"'}
  },
  'sort': [{'fecha_disposicion': 'desc'}]
}"
```

**Resultado:**
```json
{"fecha_disposicion": "20251015", "fecha_publicacion": "20251025", "rango": "1300", "titulo": "Ley 4/2025..."}
{"fecha_disposicion": "20251009", "fecha_publicacion": "20251025", "rango": "1300", "titulo": "Ley 5/2025..."}
{"fecha_disposicion": "20251009", "fecha_publicacion": "20251025", "rango": "1300", "titulo": "Ley 4/2025..."}
{"fecha_disposicion": "20250909", "fecha_publicacion": "20250919", "rango": "1300", "titulo": "Ley 7/2025..."}
{"fecha_disposicion": "20250730", "fecha_publicacion": "20250814", "rango": "1300", "titulo": "Ley 8/2025..."}
```

✅ Verificado:
- Todas son Leyes (rango 1300)
- Todas publicadas en 2025
- Ordenadas por fecha_disposicion descendente

### Conclusión V1.3

Todos los componentes funcionan correctamente por separado y combinados:
- ✅ `range` con `fecha_disposicion`
- ✅ `range` con `fecha_publicacion`
- ✅ `sort` con `query_string`
- ✅ Combinación de los tres

**Listo para implementación.**
